# 实时检测系统文件说明

## 📁 核心文件结构

```
src/realtime/
├── realtime_detection.py    # 核心检测模块
├── realtime_main.py         # 完整功能主程序
├── start_monitoring.py      # 快速启动脚本
└── vibration_control.py     # 振动控制模块
```

---

## 📄 文件详细说明

### 1. `realtime_detection.py` - 核心检测模块

**文件类型**: 核心功能模块（类库）  
**主要功能**: 实现实时音频采集、特征提取和呼噜声检测

#### 核心组件

**`RealtimeSnoreDetector` 类**
- 实时呼噜声检测的核心类
- 封装了所有检测逻辑

#### 主要方法

| 方法名 | 功能 | 说明 |
|--------|------|------|
| `__init__()` | 初始化检测器 | 加载模型、设置参数 |
| `extract_features()` | 特征提取 | 提取MFCC和Mel频谱特征 |
| `predict()` | 模型预测 | 对音频数据进行推理 |
| `process_audio_chunk()` | 处理音频块 | 处理单段音频并判断 |
| `start_detection()` | **启动实时检测** | **核心方法，开始实时监控** |
| `stop_detection()` | 停止检测 | 停止音频流和清理资源 |

#### 关键特性

- ✅ 实时音频采集（使用 pyaudio）
- ✅ 滑动窗口处理
- ✅ 连续检测计数（避免误触发）
- ✅ 实时状态显示
- ✅ 振动回调机制

#### 使用示例

```python
from realtime_detection import RealtimeSnoreDetector

# 创建检测器实例
detector = RealtimeSnoreDetector(
    model_path="models/model.h5",
    chunk_duration=1.0,      # 1秒音频窗口
    overlap=0.5,             # 50%重叠
    vibration_callback=my_callback,
    threshold=0.5            # 预测阈值
)

# 启动实时检测
detector.start_detection()  # ← 核心方法
```

#### 依赖

- `pyaudio` - 音频采集
- `librosa` - 音频特征提取
- `tensorflow` - 模型推理
- `numpy` - 数值计算

---

### 2. `realtime_main.py` - 完整功能主程序

**文件类型**: 命令行程序（完整版）  
**主要功能**: 提供完整的命令行接口，支持所有参数配置

#### 核心功能

- ✅ 命令行参数解析
- ✅ 灵活的配置选项
- ✅ 支持多种硬件平台
- ✅ 详细的启动信息显示

#### 支持的命令行参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--model` | str | `models/final_snore_detection_model.h5` | 模型文件路径 |
| `--threshold` | float | 0.5 | 预测阈值（0-1） |
| `--chunk-duration` | float | 1.0 | 音频窗口时长（秒） |
| `--overlap` | float | 0.5 | 窗口重叠比例（0-1） |
| `--vibration-controller` | str | 'auto' | 振动控制器类型 |
| `--vibration-duration` | float | 0.5 | 振动持续时间（秒） |
| `--vibration-intensity` | float | 0.8 | 振动强度（0-1） |
| `--min-snore-count` | int | 3 | 连续检测次数阈值 |

#### 使用方法

```bash
# 使用默认参数
python src/realtime/realtime_main.py

# 自定义配置
python src/realtime/realtime_main.py \
    --threshold 0.6 \
    --chunk-duration 0.5 \
    --vibration-controller raspberrypi \
    --min-snore-count 5
```

#### 程序流程

```
1. 解析命令行参数
2. 检查模型文件是否存在
3. 创建振动控制器（根据参数）
4. 创建 RealtimeSnoreDetector 实例
5. 配置参数
6. 调用 detector.start_detection() ← 调用核心方法
7. 处理中断和清理资源
```

#### 适用场景

- ✅ 生产环境部署
- ✅ 需要自定义配置
- ✅ 不同硬件平台（树莓派、Arduino等）
- ✅ 参数调优和实验

---

### 3. `start_monitoring.py` - 快速启动脚本

**文件类型**: 简化启动程序  
**主要功能**: 一键启动，使用固定配置，适合快速测试

#### 核心特点

- ✅ **零配置启动** - 无需任何参数
- ✅ 固定参数配置
- ✅ 使用模拟振动控制器
- ✅ 友好的启动界面

#### 固定配置参数

```python
chunk_duration = 1.0        # 1秒音频窗口
overlap = 0.5               # 50%重叠
threshold = 0.5             # 预测阈值
snore_threshold_count = 3   # 连续3次才触发
vibration_controller = 'simulated'  # 模拟模式
```

#### 使用方法

```bash
# 从项目根目录运行
cd Snore_Detection_Project/Snore_Detection
python src/realtime/start_monitoring.py
```

#### 程序流程

```
1. 检查模型文件是否存在
2. 创建模拟振动控制器
3. 使用固定参数创建检测器
4. 显示配置信息
5. 调用 detector.start_detection() ← 调用核心方法
```

#### 适用场景

- ✅ 快速测试和验证
- ✅ 首次使用和演示
- ✅ 无需复杂配置的场景
- ✅ 学习使用系统

---

### 4. `vibration_control.py` - 振动控制模块

**文件类型**: 硬件抽象层模块  
**主要功能**: 提供统一的振动控制接口，支持多种硬件平台

#### 核心组件

**基类：`VibrationController`**
- 定义统一的振动控制接口
- 所有具体实现类都继承自此类

**实现类：**

1. **`RaspberryPiVibrationController`** - 树莓派GPIO控制
   - 使用 GPIO 引脚控制振动器
   - 支持 PWM 控制强度
   - 默认使用 GPIO 18

2. **`ArduinoVibrationController`** - Arduino串口控制
   - 通过串口发送命令
   - 支持自定义端口和波特率
   - 需要 Arduino 端程序配合

3. **`SimulatedVibrationController`** - 模拟控制器
   - 仅打印日志，不控制硬件
   - 用于测试和开发

**工厂函数：`create_vibration_controller()`**
- 自动检测平台并创建对应的控制器
- 支持手动指定控制器类型

#### 使用方法

```python
from vibration_control import create_vibration_controller

# 自动检测平台
controller = create_vibration_controller('auto')

# 手动指定类型
controller = create_vibration_controller('raspberrypi')
controller = create_vibration_controller('arduino')
controller = create_vibration_controller('simulated')

# 触发振动
controller.vibrate(duration=0.5, intensity=0.8)

# 停止振动
controller.stop()
```

#### 支持的控制方式

| 控制器类型 | 平台 | 说明 |
|-----------|------|------|
| `raspberrypi` | 树莓派 | GPIO PWM控制 |
| `arduino` | Arduino | 串口命令控制 |
| `simulated` | 所有平台 | 模拟模式（测试用） |
| `auto` | 自动检测 | 自动选择合适的控制器 |

---

## 🔄 文件关系和调用流程

### 文件依赖关系

```
realtime_main.py
    ├─→ 导入 realtime_detection.py  (RealtimeSnoreDetector类)
    └─→ 导入 vibration_control.py   (create_vibration_controller函数)

start_monitoring.py
    ├─→ 导入 realtime_detection.py  (RealtimeSnoreDetector类)
    └─→ 导入 vibration_control.py   (create_vibration_controller函数)

realtime_detection.py
    └─→ 导入 config.py              (配置常量)
```

### 完整调用流程

```
┌─────────────────────────────────────────────┐
│        用户运行程序                          │
└─────────────────────────────────────────────┘
                    │
        ┌───────────┴───────────┐
        │                       │
        ▼                       ▼
┌───────────────┐     ┌──────────────────┐
│ start_monitoring.py │ │ realtime_main.py│
│ (简化版)            │ │ (完整版)        │
└───────────────┘     └──────────────────┘
        │                       │
        └───────────┬───────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ RealtimeSnoreDetector │
        │ (来自 realtime_       │
        │  detection.py)        │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ start_detection()     │ ← 核心检测方法
        │ - 打开音频流          │
        │ - 实时采集音频        │
        │ - 特征提取和预测      │
        │ - 触发振动回调        │
        └───────────────────────┘
                    │
                    ▼
        ┌───────────────────────┐
        │ VibrationController   │
        │ (来自 vibration_      │
        │  control.py)          │
        │ - 触发振动            │
        └───────────────────────┘
```

---

## 📊 文件对比总结

| 特性 | `realtime_detection.py` | `realtime_main.py` | `start_monitoring.py` | `vibration_control.py` |
|------|------------------------|-------------------|---------------------|----------------------|
| **类型** | 核心模块（类库） | 完整程序 | 简化程序 | 硬件抽象层 |
| **能否直接运行** | ❌ 否 | ✅ 是 | ✅ 是 | ❌ 否 |
| **主要作用** | 实现检测逻辑 | 命令行接口 | 快速启动 | 硬件控制 |
| **参数配置** | 通过构造函数 | ✅ 命令行参数 | ❌ 固定参数 | 通过工厂函数 |
| **依赖关系** | 被其他程序调用 | 调用检测模块 | 调用检测模块 | 被检测模块调用 |
| **适用场景** | 嵌入其他程序 | 生产部署 | 快速测试 | 硬件适配 |

---

## 💡 使用建议

### 场景1: 快速测试
```bash
python src/realtime/start_monitoring.py
```
- ✅ 最简单，无需配置
- ✅ 适合首次使用和验证功能

### 场景2: 自定义配置
```bash
python src/realtime/realtime_main.py \
    --threshold 0.7 \
    --vibration-controller raspberrypi
```
- ✅ 支持所有参数配置
- ✅ 适合生产环境

### 场景3: 嵌入自己的程序
```python
from realtime_detection import RealtimeSnoreDetector
from vibration_control import create_vibration_controller

controller = create_vibration_controller('raspberrypi')
detector = RealtimeSnoreDetector(
    model_path="models/model.h5",
    vibration_callback=lambda: controller.vibrate()
)
detector.start_detection()
```
- ✅ 最大灵活性
- ✅ 适合二次开发

---

## 📝 关键方法说明

### `start_detection()` 方法详解

这是**整个系统的核心方法**，位于 `realtime_detection.py` 中的 `RealtimeSnoreDetector` 类。

**功能**:
1. 初始化音频流（pyaudio）
2. 列出可用音频设备
3. 启动音频采集
4. 进入实时处理循环：
   - 读取音频数据
   - 提取特征
   - 模型预测
   - 显示实时状态
   - 触发振动回调
5. 处理中断和清理资源

**调用方式**:
```python
# 必须先创建实例
detector = RealtimeSnoreDetector(...)

# 然后调用方法
detector.start_detection()  # 开始实时检测
```

**注意**: 
- 这是一个**阻塞方法**，会一直运行直到被中断
- 按 `Ctrl+C` 可以停止
- 停止后会自动调用 `stop_detection()` 清理资源

---

## 🔗 相关文档

- **快速启动指南**: `QUICKSTART.md`
- **硬件配置指南**: `HARDWARE_SETUP.md`
- **实施路线图**: `IMPLEMENTATION_ROADMAP.md`
- **实时监控说明**: `README_实时监控.md`

---

## ❓ 常见问题

**Q: 我应该使用哪个文件？**  
A: 
- 快速测试 → `start_monitoring.py`
- 自定义配置 → `realtime_main.py`
- 嵌入开发 → 直接使用 `realtime_detection.py` 中的类

**Q: `start_detection()` 是做什么的？**  
A: 这是核心检测方法，启动实时音频采集和检测循环。

**Q: 四个文件的关系是什么？**  
A: 
- `realtime_detection.py` - 核心功能
- `vibration_control.py` - 硬件控制
- `realtime_main.py` 和 `start_monitoring.py` - 程序入口，都会调用核心功能

---

**最后更新**: 2025-11-26  
**版本**: 1.0
