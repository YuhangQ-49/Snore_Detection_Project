# éŸ³é¢‘è¾“å…¥å®ç°è¯´æ˜

## ğŸ“¢ å£°éŸ³è¾“å…¥æ–¹å¼

ç³»ç»Ÿä½¿ç”¨ **`pyaudio`** åº“ä»éº¦å…‹é£å®æ—¶é‡‡é›†éŸ³é¢‘æ•°æ®ã€‚

---

## ğŸ” æ ¸å¿ƒä»£ç ä½ç½®

éŸ³é¢‘è¾“å…¥çš„ä¸»è¦ä»£ç åœ¨ `realtime_detection.py` æ–‡ä»¶ä¸­ï¼š

### 1. åˆå§‹åŒ– PyAudio

```python
# åœ¨ start_detection() æ–¹æ³•ä¸­
self.pyaudio_instance = pyaudio.PyAudio()  # åˆ›å»º PyAudio å®ä¾‹
```

**ä½ç½®**: `realtime_detection.py` ç¬¬182è¡Œ

---

### 2. åˆ—å‡ºå¯ç”¨éŸ³é¢‘è®¾å¤‡

```python
# åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡
print("\nå¯ç”¨éŸ³é¢‘è¾“å…¥è®¾å¤‡:")
for i in range(self.pyaudio_instance.get_device_count()):
    info = self.pyaudio_instance.get_device_info_by_index(i)
    if info['maxInputChannels'] > 0:  # æ£€æŸ¥æ˜¯å¦æœ‰è¾“å…¥é€šé“
        print(f"  è®¾å¤‡ {i}: {info['name']} (é»˜è®¤: {info['defaultSampleRate']} Hz)")
```

**ä½ç½®**: `realtime_detection.py` ç¬¬185-192è¡Œ

**ä½œç”¨**: 
- æ˜¾ç¤ºç³»ç»Ÿä¸­æ‰€æœ‰å¯ç”¨çš„éº¦å…‹é£è®¾å¤‡
- å¸®åŠ©ç”¨æˆ·ç¡®è®¤éº¦å…‹é£æ˜¯å¦è¢«è¯†åˆ«

---

### 3. æ‰“å¼€éŸ³é¢‘è¾“å…¥æµ

```python
# æ‰“å¼€éŸ³é¢‘è¾“å…¥æµ
self.audio_stream = self.pyaudio_instance.open(
    format=self.format,              # éŸ³é¢‘æ ¼å¼ï¼špyaudio.paFloat32ï¼ˆ32ä½æµ®ç‚¹æ•°ï¼‰
    channels=self.channels,          # å£°é“æ•°ï¼š1ï¼ˆå•å£°é“ï¼‰
    rate=SR,                         # é‡‡æ ·ç‡ï¼š16000 Hzï¼ˆæ¥è‡ªconfig.pyï¼‰
    input=True,                      # è¾“å…¥æ¨¡å¼ï¼ˆä»éº¦å…‹é£è¯»å–ï¼‰
    frames_per_buffer=self.hop_size, # æ¯æ¬¡è¯»å–çš„å¸§æ•°
    start=False                      # æ‰‹åŠ¨å¯åŠ¨æµ
)
```

**ä½ç½®**: `realtime_detection.py` ç¬¬197-204è¡Œ

**å…³é”®å‚æ•°è¯´æ˜**:

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `format` | `pyaudio.paFloat32` | 32ä½æµ®ç‚¹éŸ³é¢‘æ ¼å¼ï¼ˆ-1.0åˆ°1.0ï¼‰ |
| `channels` | `1` | å•å£°é“ï¼ˆèŠ‚çœå¤„ç†èµ„æºï¼‰ |
| `rate` | `16000` | é‡‡æ ·ç‡16kHzï¼ˆä¸æ¨¡å‹è®­ç»ƒæ—¶ä¸€è‡´ï¼‰ |
| `input` | `True` | **å…³é”®ï¼šè®¾ç½®ä¸ºè¾“å…¥æ¨¡å¼ï¼Œä»éº¦å…‹é£è¯»å–** |
| `frames_per_buffer` | `hop_size` | æ¯æ¬¡è¯»å–çš„éŸ³é¢‘å¸§æ•° |
| `start` | `False` | ä¸è‡ªåŠ¨å¯åŠ¨ï¼Œæ‰‹åŠ¨æ§åˆ¶ |

---

### 4. å¯åŠ¨éŸ³é¢‘æµ

```python
# å¯åŠ¨éŸ³é¢‘æµï¼Œå¼€å§‹é‡‡é›†
self.audio_stream.start_stream()
```

**ä½ç½®**: `realtime_detection.py` ç¬¬212è¡Œ

**ä½œç”¨**: å¼€å§‹ä»éº¦å…‹é£æŒç»­è¯»å–éŸ³é¢‘æ•°æ®

---

### 5. å®æ—¶è¯»å–éŸ³é¢‘æ•°æ®

```python
# åœ¨å®æ—¶å¤„ç†å¾ªç¯ä¸­
while self.is_running:
    # ä»éŸ³é¢‘æµè¯»å–æ•°æ®
    audio_data_bytes = self.audio_stream.read(
        self.hop_size,                    # è¯»å–çš„å¸§æ•°
        exception_on_overflow=False       # æº¢å‡ºæ—¶ä¸æŠ›å¼‚å¸¸
    )
    
    # å°†å­—èŠ‚æ•°æ®è½¬æ¢ä¸ºnumpyæ•°ç»„
    audio_data = np.frombuffer(audio_data_bytes, dtype=np.float32)
    
    # æ·»åŠ åˆ°ç¼“å†²åŒº
    self.audio_buffer.extend(audio_data)
```

**ä½ç½®**: `realtime_detection.py` ç¬¬225-232è¡Œ

**å…³é”®ä»£ç è§£æ**:

1. **`audio_stream.read()`**: 
   - ä»éŸ³é¢‘æµè¯»å–åŸå§‹å­—èŠ‚æ•°æ®
   - é˜»å¡è°ƒç”¨ï¼Œç­‰å¾…æ•°æ®å‡†å¤‡å¥½
   - è¿”å›æŒ‡å®šå¸§æ•°çš„éŸ³é¢‘å­—èŠ‚

2. **`np.frombuffer()`**:
   - å°†å­—èŠ‚æ•°æ®è½¬æ¢ä¸ºnumpyæ•°ç»„
   - `dtype=np.float32` è¡¨ç¤º32ä½æµ®ç‚¹æ•°æ ¼å¼
   - æ•°æ®èŒƒå›´ï¼š-1.0 åˆ° 1.0

3. **`audio_buffer.extend()`**:
   - å°†æ–°çš„éŸ³é¢‘æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
   - ä½¿ç”¨ `deque` æ•°æ®ç»“æ„ï¼Œè‡ªåŠ¨é™åˆ¶å¤§å°ï¼ˆä¿å­˜3ç§’éŸ³é¢‘ï¼‰

---

## ğŸ“Š éŸ³é¢‘è¾“å…¥æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           éŸ³é¢‘è¾“å…¥æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. åˆå§‹åŒ– PyAudio
   â””â”€â†’ self.pyaudio_instance = pyaudio.PyAudio()

2. åˆ—å‡ºå¯ç”¨è®¾å¤‡ï¼ˆå¯é€‰ï¼Œç”¨äºè°ƒè¯•ï¼‰
   â””â”€â†’ æ˜¾ç¤ºæ‰€æœ‰éº¦å…‹é£è®¾å¤‡

3. æ‰“å¼€éŸ³é¢‘è¾“å…¥æµ
   â””â”€â†’ self.audio_stream = pyaudio_instance.open(
           format=pyaudio.paFloat32,  â† 32ä½æµ®ç‚¹æ ¼å¼
           channels=1,                â† å•å£°é“
           rate=16000,                â† 16kHzé‡‡æ ·ç‡
           input=True                 â† è¾“å…¥æ¨¡å¼ï¼ˆå…³é”®ï¼ï¼‰
       )

4. å¯åŠ¨éŸ³é¢‘æµ
   â””â”€â†’ self.audio_stream.start_stream()

5. å®æ—¶å¾ªç¯è¯»å–
   â””â”€â†’ while is_running:
          audio_bytes = audio_stream.read()    â† è¯»å–åŸå§‹å­—èŠ‚
          audio_array = np.frombuffer(...)     â† è½¬æ¢ä¸ºæ•°ç»„
          audio_buffer.extend(audio_array)     â† å­˜å…¥ç¼“å†²åŒº

6. å¤„ç†éŸ³é¢‘æ•°æ®
   â””â”€â†’ ä»ç¼“å†²åŒºæå–1ç§’éŸ³é¢‘ â†’ ç‰¹å¾æå– â†’ æ¨¡å‹é¢„æµ‹
```

---

## ğŸ”§ éŸ³é¢‘å‚æ•°é…ç½®

éŸ³é¢‘è¾“å…¥çš„å…³é”®å‚æ•°åœ¨ `realtime_detection.py` çš„ `__init__` æ–¹æ³•ä¸­è®¾ç½®ï¼š

```python
def __init__(self, model_path, chunk_duration=1.0, overlap=0.5, ...):
    # éŸ³é¢‘å‚æ•°
    self.chunk_size = int(SR * chunk_duration)        # æ¯æ¬¡å¤„ç†çš„é‡‡æ ·ç‚¹æ•°
    self.hop_size = int(SR * chunk_duration * (1 - overlap))  # æ¯æ¬¡è¯»å–çš„é‡‡æ ·ç‚¹æ•°
    self.format = pyaudio.paFloat32                   # éŸ³é¢‘æ ¼å¼
    self.channels = 1                                 # å•å£°é“
    
    # éŸ³é¢‘ç¼“å†²åŒºï¼ˆä¿å­˜3ç§’éŸ³é¢‘ï¼‰
    self.audio_buffer = deque(maxlen=int(SR * 3))
```

**å‚æ•°è¯´æ˜**:

| å‚æ•° | æ¥æº | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `SR` | `config.py` | `16000` | é‡‡æ ·ç‡ï¼ˆHzï¼‰ |
| `chunk_duration` | æ„é€ å‡½æ•°å‚æ•° | `1.0` | å¤„ç†çª—å£æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `overlap` | æ„é€ å‡½æ•°å‚æ•° | `0.5` | çª—å£é‡å æ¯”ä¾‹ |
| `chunk_size` | è®¡ç®—å€¼ | `16000` | æ¯æ¬¡å¤„ç†çš„é‡‡æ ·ç‚¹æ•° |
| `hop_size` | è®¡ç®—å€¼ | `8000` | æ¯æ¬¡è¯»å–çš„é‡‡æ ·ç‚¹æ•° |

---

## ğŸ“ å®Œæ•´ä»£ç ç¤ºä¾‹

### æœ€å°åŒ–éŸ³é¢‘è¾“å…¥ç¤ºä¾‹

```python
import pyaudio
import numpy as np

# 1. åˆ›å»º PyAudio å®ä¾‹
p = pyaudio.PyAudio()

# 2. æ‰“å¼€éŸ³é¢‘è¾“å…¥æµ
stream = p.open(
    format=pyaudio.paFloat32,  # 32ä½æµ®ç‚¹æ ¼å¼
    channels=1,                # å•å£°é“
    rate=16000,                # é‡‡æ ·ç‡ 16kHz
    input=True,                # è¾“å…¥æ¨¡å¼ï¼ˆä»éº¦å…‹é£è¯»å–ï¼‰
    frames_per_buffer=8000     # æ¯æ¬¡è¯»å–8000ä¸ªé‡‡æ ·ç‚¹ï¼ˆ0.5ç§’ï¼‰
)

# 3. å¯åŠ¨æµ
stream.start_stream()

# 4. è¯»å–éŸ³é¢‘æ•°æ®
try:
    while True:
        # è¯»å–éŸ³é¢‘æ•°æ®ï¼ˆé˜»å¡è°ƒç”¨ï¼‰
        audio_bytes = stream.read(8000, exception_on_overflow=False)
        
        # è½¬æ¢ä¸ºnumpyæ•°ç»„
        audio_data = np.frombuffer(audio_bytes, dtype=np.float32)
        
        # å¤„ç†éŸ³é¢‘æ•°æ®...
        print(f"æ”¶åˆ°éŸ³é¢‘æ•°æ®: {len(audio_data)} ä¸ªé‡‡æ ·ç‚¹")
        
except KeyboardInterrupt:
    # åœæ­¢å’Œæ¸…ç†
    stream.stop_stream()
    stream.close()
    p.terminate()
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### å£°éŸ³è¾“å…¥çš„æ ¸å¿ƒä»£ç 

1. **åˆ›å»º PyAudio å®ä¾‹**
   ```python
   self.pyaudio_instance = pyaudio.PyAudio()
   ```

2. **æ‰“å¼€è¾“å…¥æµï¼ˆå…³é”®ï¼š`input=True`ï¼‰**
   ```python
   self.audio_stream = self.pyaudio_instance.open(
       input=True,  # â† è¿™æ˜¯å…³é”®ï¼è®¾ç½®ä¸ºè¾“å…¥æ¨¡å¼
       ...
   )
   ```

3. **è¯»å–éŸ³é¢‘æ•°æ®**
   ```python
   audio_data_bytes = self.audio_stream.read(self.hop_size)
   audio_data = np.frombuffer(audio_data_bytes, dtype=np.float32)
   ```

### ä¸ºä»€ä¹ˆä½¿ç”¨ pyaudioï¼Ÿ

- âœ… **è·¨å¹³å°æ”¯æŒ**: Windowsã€Linuxã€macOS
- âœ… **å®æ—¶æ€§èƒ½**: ä½å»¶è¿ŸéŸ³é¢‘é‡‡é›†
- âœ… **ç®€å•æ˜“ç”¨**: APIæ¸…æ™°ç›´è§‚
- âœ… **æˆç†Ÿç¨³å®š**: å¹¿æ³›ä½¿ç”¨çš„éŸ³é¢‘åº“

---

## ğŸ” éŸ³é¢‘è¾“å…¥è®¾å¤‡é€‰æ‹©

### é»˜è®¤è®¾å¤‡

ä»£ç ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„éŸ³é¢‘è¾“å…¥è®¾å¤‡ã€‚å¦‚æœéœ€è¦æŒ‡å®šç‰¹å®šè®¾å¤‡ï¼š

```python
# è·å–è®¾å¤‡ä¿¡æ¯
device_info = pyaudio_instance.get_device_info_by_index(device_index)

# æŒ‡å®šè¾“å…¥è®¾å¤‡
stream = pyaudio_instance.open(
    input_device_index=device_index,  # æŒ‡å®šè®¾å¤‡ç´¢å¼•
    input=True,
    ...
)
```

### å¸¸è§éŸ³é¢‘è¾“å…¥è®¾å¤‡

- **å†…ç½®éº¦å…‹é£**: ç¬”è®°æœ¬ç”µè„‘å†…ç½®
- **USBéº¦å…‹é£**: å¤–æ¥USBéº¦å…‹é£
- **è“ç‰™éº¦å…‹é£**: è“ç‰™è¿æ¥çš„éº¦å…‹é£
- **éŸ³é¢‘æ¥å£**: ä¸“ä¸šéŸ³é¢‘æ¥å£

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæ²¡æœ‰å£°éŸ³è¾“å…¥ï¼Ÿ

**å¯èƒ½åŸå› **:
1. éº¦å…‹é£æœªè¿æ¥
2. éº¦å…‹é£æƒé™æœªæˆäºˆ
3. ç³»ç»ŸéŸ³é¢‘è®¾ç½®é—®é¢˜

**è§£å†³æ–¹æ³•**:
```python
# æ£€æŸ¥å¯ç”¨è®¾å¤‡
p = pyaudio.PyAudio()
for i in range(p.get_device_count()):
    info = p.get_device_info_by_index(i)
    if info['maxInputChannels'] > 0:
        print(f"è®¾å¤‡ {i}: {info['name']}")
```

### Q2: å¦‚ä½•æŒ‡å®šç‰¹å®šçš„éº¦å…‹é£ï¼Ÿ

ä¿®æ”¹ `start_detection()` æ–¹æ³•ï¼Œæ·»åŠ è®¾å¤‡ç´¢å¼•ï¼š

```python
# åœ¨æ‰“å¼€éŸ³é¢‘æµæ—¶æ·»åŠ 
self.audio_stream = self.pyaudio_instance.open(
    input_device_index=1,  # æŒ‡å®šè®¾å¤‡ç´¢å¼•ï¼ˆä»åˆ—å‡ºçš„è®¾å¤‡ä¸­é€‰æ‹©ï¼‰
    input=True,
    ...
)
```

### Q3: é‡‡æ ·ç‡å¯ä»¥æ”¹å˜å—ï¼Ÿ

å¯ä»¥ï¼Œä½†éœ€è¦ï¼š
1. ä¿®æ”¹ `config.py` ä¸­çš„ `SR` å€¼
2. ç¡®ä¿ä¸æ¨¡å‹è®­ç»ƒæ—¶çš„é‡‡æ ·ç‡ä¸€è‡´
3. é‡æ–°è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚æœæ”¹å˜é‡‡æ ·ç‡ï¼‰

---

## ğŸ“š ç›¸å…³ä»£ç ä½ç½®

- **éŸ³é¢‘åˆå§‹åŒ–**: `realtime_detection.py` ç¬¬182è¡Œ
- **æ‰“å¼€éŸ³é¢‘æµ**: `realtime_detection.py` ç¬¬197-204è¡Œ
- **è¯»å–éŸ³é¢‘æ•°æ®**: `realtime_detection.py` ç¬¬228è¡Œ
- **éŸ³é¢‘å‚æ•°é…ç½®**: `realtime_detection.py` ç¬¬45-52è¡Œ
- **é‡‡æ ·ç‡é…ç½®**: `config.py` ç¬¬18è¡Œ

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **pyaudio å®˜æ–¹æ–‡æ¡£**: https://people.csail.mit.edu/hubert/pyaudio/docs/
- **é¡¹ç›®æ–‡ä»¶è¯´æ˜**: `æ–‡ä»¶è¯´æ˜.md`
- **å¿«é€Ÿå¯åŠ¨æŒ‡å—**: `QUICKSTART.md`

---

**æ€»ç»“**: å£°éŸ³è¾“å…¥é€šè¿‡ `pyaudio` åº“å®ç°ï¼Œå…³é”®æ˜¯å°† `input=True` è®¾ç½®ä¸ºè¾“å…¥æ¨¡å¼ï¼Œç„¶åé€šè¿‡ `audio_stream.read()` æ–¹æ³•æŒç»­ä»éº¦å…‹é£è¯»å–éŸ³é¢‘æ•°æ®ã€‚

